name: SQL Runner

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev, qa, prod)'
        required: true
        type: string
      file:
        description: 'SQL file to run (optional, leave blank to list files)'
        required: false
        type: string

jobs:
  sql-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          echo "ENV=${{ github.event.inputs.env }}" >> $GITHUB_ENV
          echo "FILE=${{ github.event.inputs.file }}" >> $GITHUB_ENV

      - name: Determine action
        id: decide
        run: |
          if [ -z "$FILE" ]; then
            echo "action=list" >> $GITHUB_ENV
          else
            echo "action=run" >> $GITHUB_ENV
          fi

      - name: List SQL files
        if: env.action == 'list'
        run: |
          echo "Listing all SQL files in sql/$ENV/:"
          ls sql/$ENV/*.sql

      - name: Upload SQL file list
        if: env.action == 'list'
        uses: actions/upload-artifact@v4
        with:
          name: sql-file-list
          path: sql/$ENV/*.sql

      - name: Run selected SQL file
        if: env.action == 'run'
        run: |
          SQL_PATH="sql/$ENV/$FILE"
          if [ ! -f "$SQL_PATH" ]; then
            echo "Error: File $SQL_PATH does not exist!"
            exit 1
          fi
          echo "Running SQL file: $SQL_PATH"
          # Replace below with your actual DB command, e.g., PostgreSQL
          # psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f "$SQL_PATH"
          echo "Simulating execution of $SQL_PATH"
